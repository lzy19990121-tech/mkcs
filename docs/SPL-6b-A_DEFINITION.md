# SPL-6b-A: 优化问题定义 - 完成报告

**完成日期**: 2026-02-01
**状态**: ✅ 已完成

---

## 📋 任��完成情况

### ✅ 定义优化决策变量

| 变量名 | 类型 | 维度 | 描述 |
|--------|------|------|------|
| `strategy_weights` | 连续 | n_strategies | 每个策略的权重 [0, 1] |
| `strategy_switches` | 二进制 | n_strategies | 策略开关（暂不启用） |

**设计决策**：
- 选择连续变量而非二进制变量，降低优化复杂度
- 权重范围 [0, 1]，支持部分持仓（现金缓冲）

### ✅ 定义目标函数

#### 主目标
```python
maximize w^T * mu
```
- 最大化预期收益
- `w`: 权重向量
- `mu`: 预期收益向量（基于历史或近窗估计）

#### 次要目标
```python
minimize w^T * Sigma * w
```
- 最小化风险（作为次要目标或约束）
- `Sigma`: 协方差矩阵

#### 惩罚项
- `turnover_penalty`: 换手惩罚（0.01）
- `smoothness_penalty`: 权重平滑惩罚（0.05）

### ✅ 定义硬约束（7类）

#### 1. 收益约束（2个）
| 约束名 | 阈值 | 描述 |
|--------|------|------|
| `P95_return_lower_bound` | -10% | 组合 P95 收益不低于 -10% |
| `P99_return_lower_bound` | -15% | 组合 P99 收益不低于 -15% |

#### 2. 风险约束（2个）
| ��束名 | 阈值 | 描述 |
|--------|------|------|
| `max_drawdown_upper_bound` | 12% | 最大回撤不超过 12% |
| `drawdown_duration_upper_bound` | 20天 | 回撤持续时长不超过 20 天 |

#### 3. 权重约束（4个）
| 约束名 | 类型 | 值 | 描述 |
|--------|------|------|------|
| `weight_bounds` | 不等式 | [0, 1] | 每个策略的权重范围 |
| `sum_weights` | 等式 | 1.0 | 权重总和为1（完全投资） |
| `max_single_weight` | 不等式 | 0.4 | 单个策略不超过 40% |
| `min_single_weight` | 不等式 | 0.05 | 每个开启的策略至少 5% |

#### 4. 协同爆炸约束（2个）
| 约束名 | 阈值 | 描述 |
|--------|------|------|
| `tail_correlation_limit` | 0.5 | 压力期相关性不超过 0.5 |
| `co_crash_limit` | 2 | 最多 2 个策略同时尾部亏损 |

#### 5. 风险预算约束（2个）
| 约束名 | 阈值 | 描述 |
|--------|------|------|
| `total_var_budget` | 8% | 组合总方差预算 |
| `strategy_var_budget` | 3% | 单策略方差预算 |

#### 6. 权重平滑约束（2个）
| 约束名 | 阈值 | 描述 |
|--------|------|------|
| `max_weight_change` | 20% | 单次最大权重变化 |
| `turnover_limit` | 50%/月 | 月度换手率限制 |

---

## 📁 创建的文件

### 1. `config/optimization_problem.yaml`
- 完整的优化问题配置
- 决策变量定义
- 目标函数（主+次+惩罚）
- 7类硬约束
- 优化器配置
- 无解与降级策略

### 2. `analysis/optimization_problem.py`
核心类：

#### `OptimizationProblem`
- 优化问题数据结构
- `from_config()`: 从 YAML 加载配置
- `get_bounds()`: 获取权重边界
- `validate()`: 验证问题设置

#### `OptimizationResult`
- 优化结果数据结构
- 包含成功标志、权重、目标值、约束满足情况
- 诊断信息：绑定约束、约束违反、迭代次数、计算时间
- 可解释性：预期收益、风险、边际贡献

#### `Constraint`
- 约束定义数据结构

#### `ObjectiveFunction`
- 目标函数数据结构

---

## 🎯 关键设计决策

### 1. 优化方法选择
- **主方法**: 二次规划（Quadratic Programming）- 凸优化，全局最优
- **降级方法**: 投影梯度下降（Projected Gradient）- 简单可控

### 2. 约束处理策略
- **主方法**: 惩罚法（Penalty Method）- 软约束
- **参数**: 惩罚系数 1000，障碍参数 0.1
- **无解时**: 按优先级放松约束（平滑→权重→相关性→风险预算）

### 3. 数据源配置
- **预期收益**: 历史均值（90天窗口）
- **协方差**: 样本协方差（带 Ledoit-Wolf 压缩）
- **压力期**: SPL-4 worst windows，权重 2x
- **相关性**: Pearson 相关（60天窗口）

### 4. 与 SPL-5b 的兼容性
- **模式**: enhancement（增强模式）
- **保留**: 风险预算定义
- **回退**: 优化失败时使用 SPL-5b 规则分配器

---

## 📊 优化问题规模

- **决策变量**: n（策略数量）
- **等式约束**: 1 个（sum_weights）
- **不等式约束**: 15+ 个
- **边界约束**: n 个（每个策略的 [0, 1]）

---

## 🚀 下一步：SPL-6b-B

需要构建可优化的风险代理：
1. CVaR 约束（条件风险价值）
2. Variance / Semi-variance（方差/半方差）
3. Correlation-aware penalty（相关性惩罚）

---

**生成时间**: 2026-02-01
**SPL-6b 进度**: 1/6 (17%) ✅
